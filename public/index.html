<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>“Las Cartas del Caos”</title>
  <style>
    /* ======== ESTILOS PRINCIPALES ======== */
    body {
      margin: 0;
      padding: 0;
      font-family: "Trebuchet MS", sans-serif;
      background: linear-gradient(135deg, #3f4c6b, #606c88);
      color: #f0f0f0;
    }
    h1, h2, h3 {
      text-align: center;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }

    /* Contenedor para lobby y juego */
    #lobby, #game {
      max-width: 850px;
      margin: 30px auto;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }

    /* Lobby inputs y layout */
    #lobby input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 5px;
    }

    /* Botones genéricos */
    button {
      background: #2ecc71; /* Tono verde/teal */
      border: none;
      border-radius: 4px;
      padding: 10px 15px;
      color: #fff;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
      transition: background 0.3s;
    }
    button:hover {
      background: #27ae60;
    }
    button:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }

    /* Caja de cartas */
    .card-box {
      border:1px solid #aaa;
      border-radius:6px;
      padding:10px;
      margin:5px;
      display:inline-block;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
      transition: transform 0.2s;
      background: #fff;
      color: #000;
      min-width: 140px;
      text-align: center;
    }
    .card-box:hover {
      transform: scale(1.02);
    }
    .card-black {
      background:#2d3436;
      color:#fff;
    }
    .card-white {
      background:#fafafa;
      color:#2c3e50;
    }
    .card-selected {
      border:2px solid #2ecc71;
    }

    /* Submissions primero, luego la mano */
    #submissionsSection {
      margin-bottom: 20px;
    }

    /* Mensajes */
    #statusMsg {
      font-style: italic;
      margin-top: 10px;
      color: #2ecc71; /* verde suave */
    }
    #discardingStatus {
      margin-top:5px; 
      color:#e67e22; /* naranja */
      font-weight:bold;
    }
    #zarIndicator {
      margin-bottom:10px;
    }

    /* Pantalla Intermedia */
    #intermediateScreen {
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      color:#fff; 
      display:none; 
      justify-content:center; 
      align-items:center; 
      text-align:center;
      z-index:9999;
    }
    #intermediateMsg {
      background: rgba(20, 20, 20, 0.8);
      border: 2px solid #2ecc71;
      border-radius: 10px;
      width: 380px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
      font-size:1.1em;
    }

    /* Ganador */
    #winnerCard {
      margin-top:6px;
      font-weight:bold;
      color:#2ecc71;
    }
  </style>
</head>
<body>
  <h1>“Las Cartas del Caos”</h1>

  <div id="intermediateScreen">
    <div id="intermediateMsg"></div>
  </div>

  <!-- LOBBY -->
  <div id="lobby">
    <input type="text" id="playerName" placeholder="Tu nombre...">
    <button id="joinBtn">Unirse</button>
    <button id="startBtn" style="display:none;">Iniciar Partida</button>
    <button id="disconnectBtn" style="display:none;">Desconectarse</button>

    <div id="playersList"></div>
  </div>

  <!-- PARTIDA -->
  <div id="game" style="display:none;">
    <h2>Partida en curso</h2>
    <div id="zarIndicator" style="display:none;">¡Eres el ZAR!</div>

    <div id="submissionsSection" style="display:none;">
      <h3>Cartas enviadas:</h3>
      <div id="submissionsList"></div>
    </div>

    <div id="blackCardContainer" style="margin-bottom:20px;"></div>
    <div id="winnerCard" style="display:none;"></div>

    <div>
      <h3>Mi mano:</h3>
      <div id="myHand"></div>

      <div style="margin-top:10px;">
        <button id="sendBtn" style="display:none;">Enviar Carta Seleccionada</button>
        <button id="discardBtn">Descartar Cartas Seleccionadas (Max. 3)</button>
        <button id="omitBtn" style="display:none;">Omitir Descarte</button>
      </div>

      <div id="statusMsg"></div>
      <div id="discardingStatus"></div>
    </div>

    <div id="resultsSection" style="display:none; margin-top:20px;">
      <h3>Resultado de la Ronda:</h3>
      <div id="winnerInfo"></div>
    </div>

    <!-- Botón "Terminar Partida" -->
    <button id="endGameBtn" style="display:none; margin-top:20px;">Terminar Partida</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // LOBBY
    const lobbyDiv = document.getElementById('lobby');
    const playerNameInput = document.getElementById('playerName');
    const joinBtn = document.getElementById('joinBtn');
    const startBtn = document.getElementById('startBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const playersList = document.getElementById('playersList');

    // PARTIDA
    const gameDiv = document.getElementById('game');
    const zarIndicator = document.getElementById('zarIndicator');
    const submissionsSection = document.getElementById('submissionsSection');
    const submissionsList = document.getElementById('submissionsList');
    const blackCardContainer = document.getElementById('blackCardContainer');
    const winnerCardDiv = document.getElementById('winnerCard');
    const myHandDiv = document.getElementById('myHand');
    const statusMsg = document.getElementById('statusMsg');
    const discardingStatus = document.getElementById('discardingStatus');
    const resultsSection = document.getElementById('resultsSection');
    const winnerInfo = document.getElementById('winnerInfo');

    // BOTONES
    const sendBtn = document.getElementById('sendBtn');
    const discardBtn = document.getElementById('discardBtn');
    const omitBtn = document.getElementById('omitBtn');
    const endGameBtn = document.getElementById('endGameBtn');

    // INTERMEDIA
    const intermediateScreen = document.getElementById('intermediateScreen');
    const intermediateMsg = document.getElementById('intermediateMsg');

    // Variables
    let myPlayerId = null;
    let isZar = false;
    let myHand = [];
    let selectedCards = [];
    let hasSentCard = false;

    /********************************************************
     * Socket.IO
     ********************************************************/
    socket.on('connect', () => {
      myPlayerId = socket.id;
      console.log("Conectado ID:", myPlayerId);
    });

    socket.on('errorMessage', (data) => {
      alert(data.message);
    });

    // Botón Unirse
    joinBtn.addEventListener('click', () => {
      const name = playerNameInput.value.trim();
      if (name) {
        socket.emit('joinGame', name);
      } else {
        alert("Ingresa un nombre válido");
      }
    });

    // Botón Iniciar
    startBtn.addEventListener('click', () => {
      socket.emit('startGame');
    });

    // Botón Desconectar
    disconnectBtn.addEventListener('click', () => {
      socket.emit('disconnectPlayer');
      resetUI();
    });

    // Botón Terminar Partida (contraseña)
    endGameBtn.addEventListener('click', () => {
      const pass = prompt("Contraseña para terminar la partida (\"joaquin\"): ");
      if (!pass) return;
      socket.emit('endGame', pass);
    });

    // updatePlayers
    socket.on('updatePlayers', (data) => {
      playersList.innerHTML = "<h3>Jugadores Conectados:</h3>";
      data.players.forEach(p => {
        playersList.innerHTML += `<div>${p.name}</div>`;
      });
      joinBtn.style.display = 'none';
      playerNameInput.style.display = 'none';
      disconnectBtn.style.display = 'block';
      startBtn.style.display = 'block';
    });

    // roundStarted
    socket.on('roundStarted', (data) => {
      intermediateScreen.style.display='none';
      lobbyDiv.style.display='none';
      gameDiv.style.display='block';

      resultsSection.style.display='none';
      winnerInfo.innerHTML='';
      submissionsSection.style.display='none';
      submissionsList.innerHTML='';
      statusMsg.innerText='';
      discardingStatus.innerText='';
      winnerCardDiv.style.display='none';
      winnerCardDiv.innerText='';

      const me = data.players.find(x => x.id === myPlayerId);
      isZar = me ? me.isCzar : false;
      if (isZar) {
        zarIndicator.style.display='block';
        sendBtn.style.display='none';
      } else {
        zarIndicator.style.display='none';
        sendBtn.style.display='inline-block';
      }
      sendBtn.disabled= false;
      selectedCards= [];
      hasSentCard= false;

      if (data.blackCard) {
        blackCardContainer.innerHTML= renderBlackCard(data.blackCard.text);
      } else {
        blackCardContainer.innerHTML= `<div class="card-box card-black">???</div>`;
      }

      endGameBtn.style.display='block';
      omitBtn.style.display='none';
    });

    // yourHand
    socket.on('yourHand', (d) => {
      myHand= d.cards;
      renderMyHand();
    });

    // showSubmissions (mostrar cartas enviadas ARRIBA de la mano)
    socket.on('showSubmissions', (subs) => {
      submissionsSection.style.display='block';
      submissionsList.innerHTML='';
      subs.forEach(s=> {
        const div= document.createElement('div');
        div.classList.add('card-box','card-white');
        div.innerHTML= `
          <p>${s.text}</p>
          ${
            isZar ? `<button onclick="selectWinner('${s.submissionId}')">Elegir Ganadora</button>` : ''
          }
        `;
        submissionsList.appendChild(div);
      });
    });

    // roundResult
    socket.on('roundResult', (d) => {
      resultsSection.style.display='block';
      winnerInfo.innerHTML= `
        Ganó <strong>${d.winnerName}</strong> (+${d.pointsWon} punto).<br/>
        Total: ${d.totalPoints} puntos.
      `;
      winnerCardDiv.style.display='block';
      winnerCardDiv.innerHTML= renderWhiteCard(d.winnerCardText);
    });

    // hideSubmissions
    socket.on('hideSubmissions', () => {
      submissionsSection.style.display='none';
      submissionsList.innerHTML='';
    });

    // stillDiscarding
    socket.on('stillDiscarding', (data) => {
      discardingStatus.textContent= data.text; // Más limpio que innerHTML
      omitBtn.style.display='inline-block';
    });

    // discardPhaseEnded
    socket.on('discardPhaseEnded', () => {
      discardingStatus.textContent='';
      omitBtn.style.display='none';
    });

    // showIntermediate con countdown real
    socket.on('showIntermediate', (d) => {
      intermediateScreen.style.display='flex';
      let timeLeft = d.timeLeft || 3; 
      let msg = `<p>La siguiente ronda iniciará en <span id="countdownVal">${timeLeft}</span> seg...</p>`;
      
      if (d.scores) {
        msg += "<h3>Puntajes actuales:</h3><ul>";
        d.scores.forEach(s=>{
          msg += `<li>${s.name}: ${s.points}</li>`;
        });
        msg += "</ul>";
      }
      intermediateMsg.innerHTML= msg;

      // Countdown
      let inter = setInterval(() => {
        timeLeft--;
        const cdSpan = document.getElementById('countdownVal');
        if (cdSpan) {
          cdSpan.textContent = timeLeft;
        }
        if (timeLeft <= 0) {
          clearInterval(inter);
        }
      }, 1000);
    });

    // updateHand
    socket.on('updateHand', (d) => {
      myHand= d.cards;
      renderMyHand();
    });

    // gameEnded
    socket.on('gameEnded', (d) => {
      let txt= `<h2>¡La partida ha terminado!</h2><ul>`;
      d.scores.forEach(s=> {
        txt+= `<li>${s.name}: ${s.points}</li>`;
      });
      txt+="</ul>";
      intermediateMsg.innerHTML= txt;
      intermediateScreen.style.display='flex';
      setTimeout(()=>{
        intermediateScreen.style.display='none';
        resetUI();
      }, 4000);
    });

    /********************************************************
     * Botones de PARTIDA
     ********************************************************/
    sendBtn.addEventListener('click', () => {
      if (hasSentCard) {
        statusMsg.textContent="Ya enviaste tu carta.";
        return;
      }
      if (selectedCards.length !== 1) {
        statusMsg.textContent="Selecciona 1 carta para enviar.";
        return;
      }
      if (isZar) {
        statusMsg.textContent="Eres el ZAR, no envías carta.";
        return;
      }
      const chosen= selectedCards[0];
      socket.emit('sendCard', chosen.id);
      hasSentCard= true;
      sendBtn.disabled= true;
      statusMsg.textContent="Carta enviada.";
      selectedCards=[];
      renderMyHand();
    });

    discardBtn.addEventListener('click', () => {
      if (selectedCards.length===0) {
        statusMsg.textContent="No seleccionaste ninguna carta para descartar.";
        return;
      }
      if (selectedCards.length>3) {
        statusMsg.textContent="Máximo 3 cartas para descartar.";
        return;
      }
      const arr= selectedCards.map(c=> c.id);
      socket.emit('discardCards', arr);
      statusMsg.textContent=`Descartaste ${selectedCards.length} carta(s).`;
      selectedCards=[];
      renderMyHand();
    });

    omitBtn.addEventListener('click', () => {
      socket.emit('omitDiscard');
      statusMsg.textContent= "Has omitido descartar.";
      omitBtn.style.display='none';
    });

    /********************************************************
     * FUNCIONES AUX
     ********************************************************/
    function resetUI() {
      lobbyDiv.style.display='block';
      gameDiv.style.display='none';
      playerNameInput.value='';
      joinBtn.style.display='block';
      disconnectBtn.style.display='none';
      startBtn.style.display='none';
      endGameBtn.style.display='none';
    }

    function renderMyHand(){
      myHandDiv.innerHTML= '';
      selectedCards= [];
      myHand.forEach(card => {
        const cDiv= document.createElement('div');
        cDiv.classList.add('card-box','card-white');
        cDiv.textContent= card.text;
        cDiv.addEventListener('click', () => {
          toggleCard(card, cDiv);
        });
        myHandDiv.appendChild(cDiv);
      });
    }

    function toggleCard(card, elDiv){
      const i= selectedCards.findIndex(x=> x.id=== card.id);
      if(i>=0){
        selectedCards.splice(i,1);
        elDiv.classList.remove('card-selected');
      } else {
        selectedCards.push(card);
        elDiv.classList.add('card-selected');
      }
    }

    function selectWinner(submissionId){
      socket.emit('selectWinner', submissionId);
    }
    window.selectWinner = selectWinner;

    function renderBlackCard(txt){
      return `<div class="card-box card-black">${txt}</div>`;
    }
    function renderWhiteCard(txt){
      return `<div class="card-box card-white">${txt}</div>`;
    }
  </script>
</body>
</html>
