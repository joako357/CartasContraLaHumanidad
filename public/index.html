<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego Ajustado</title>
  <style>
    .card-selection {
      border: 1px solid blue; 
      margin: 3px; 
      padding: 3px; 
      display: inline-block; 
      cursor: pointer;
      background-color: #f5f5f5;
    }
    .card-selected {
      background-color: #d3ffd3;
    }
    /* Pantalla intermedia */
    #intermediateScreen {
      position: fixed; 
      top:0; left:0; 
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); 
      color: #fff;
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 9999;
    }
    #intermediateMsg {
      font-size: 2em;
      text-align: center;
    }
    #discardingStatus {
      color: brown; 
      margin-top: 10px; 
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Mi Juego</h1>

  <!-- Pantalla intermedia -->
  <div id="intermediateScreen">
    <div id="intermediateMsg"></div>
  </div>

  <!-- LOBBY -->
  <div id="lobby">
    <input type="text" id="playerName" placeholder="Tu nombre">
    <button id="joinBtn">Unirse</button>
    <button id="startBtn" style="display: none;">Iniciar Partida</button>
    <button id="disconnectBtn" style="display: none;">Desconectarse</button>
    <button id="endGameBtn" style="display: none;">Terminar Partida</button>
    <div id="playersList"></div>
  </div>

  <!-- PANTALLA DE JUEGO -->
  <div id="game" style="display: none;">
    <h2>Partida en curso</h2>
    <div id="zarIndicator" style="color:red; display:none;">¡ERES EL ZAR!</div>
    <div>
      <strong id="blackCardPrompt"></strong>
    </div>

    <div>
      <h3>Mi mano (8 cartas):</h3>
      <div id="myHand"></div>
      <div style="margin-top:10px;">
        <label><input type="radio" name="mode" value="send" checked> Modo Enviar</label>
        <label><input type="radio" name="mode" value="discard"> Modo Descartar</label>
      </div>

      <button id="submitCardBtn" style="display:none;">Enviar Carta Seleccionada</button>
      <button id="discardBtn">Descartar Carta(s) (máx 3)</button>

      <div id="statusMsg" style="color:green;"></div>
      <div id="discardingStatus"></div>
    </div>

    <div id="submissionsSection" style="display:none;">
      <h3>Cartas enviadas:</h3>
      <div id="submissionsList"></div>
    </div>

    <div id="resultsSection" style="display:none;">
      <h3>Resultado de la ronda:</h3>
      <div id="winnerInfo"></div>
    </div>
  </div>

  <!-- Script de Socket.IO (cliente) -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    /********************************************************
     * DOM
     ********************************************************/
    const socket = io();

    // Lobby
    const lobbyDiv = document.getElementById('lobby');
    const playerNameInput = document.getElementById('playerName');
    const joinBtn = document.getElementById('joinBtn');
    const startBtn = document.getElementById('startBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const endGameBtn = document.getElementById('endGameBtn');
    const playersList = document.getElementById('playersList');

    // Juego
    const gameDiv = document.getElementById('game');
    const zarIndicator = document.getElementById('zarIndicator');
    const blackCardPrompt = document.getElementById('blackCardPrompt');
    const myHandDiv = document.getElementById('myHand');
    const statusMsg = document.getElementById('statusMsg');
    const discardingStatus = document.getElementById('discardingStatus');
    const modeRadios = document.getElementsByName('mode');
    const submitCardBtn = document.getElementById('submitCardBtn');
    const discardBtn = document.getElementById('discardBtn');
    const submissionsSection = document.getElementById('submissionsSection');
    const submissionsList = document.getElementById('submissionsList');
    const resultsSection = document.getElementById('resultsSection');
    const winnerInfo = document.getElementById('winnerInfo');

    // Pantalla intermedia
    const intermediateScreen = document.getElementById('intermediateScreen');
    const intermediateMsg = document.getElementById('intermediateMsg');

    // Variables
    let myPlayerId = null;
    let isZar = false;
    let myHand = [];
    let selectedCards = [];
    let hasSentCard = false;
    let iAmHost = false;

    /********************************************************
     * BOTONES
     ********************************************************/
    joinBtn.addEventListener('click', () => {
      const name = playerNameInput.value.trim();
      if (name) {
        socket.emit('joinGame', name);
      }
    });

    disconnectBtn.addEventListener('click', () => {
      socket.emit('disconnectPlayer');
      resetUI();
    });

    startBtn.addEventListener('click', () => {
      socket.emit('startGame');
    });

    submitCardBtn.addEventListener('click', () => {
      if (hasSentCard) {
        alert("Ya enviaste tu carta.");
        return;
      }
      if (selectedCards.length !== 1) {
        alert("Selecciona exactamente 1 carta.");
        return;
      }
      if (isZar) {
        alert("Eres el ZAR, no envías carta.");
        return;
      }
      const chosenCard = selectedCards[0];
      socket.emit('submitCards', { chosenCard });
      hasSentCard = true;
      submitCardBtn.disabled = true;
      statusMsg.innerText = "¡Carta enviada!";
      selectedCards = [];
      renderMyHand();
    });

    discardBtn.addEventListener('click', () => {
      if (selectedCards.length === 0) {
        alert("No seleccionaste cartas para descartar.");
        return;
      }
      if (selectedCards.length > 3) {
        alert("Máximo 3 cartas.");
        return;
      }
      const discardIds = selectedCards.map(c => c.id);
      socket.emit('requestDiscard', { discardCardIds: discardIds });
      statusMsg.innerText = "Descartaste " + selectedCards.length + " carta(s).";
      selectedCards = [];
      renderMyHand();
    });

    endGameBtn.addEventListener('click', () => {
      socket.emit('endGame');
    });

    /********************************************************
     * SOCKET LISTENERS
     ********************************************************/
    socket.on('connect', () => {
      myPlayerId = socket.id;
    });

    socket.on('errorMessage', (data) => {
      alert(data.message);
    });

    socket.on('updatePlayers', (data) => {
      playersList.innerHTML = '<h3>Jugadores conectados:</h3>';
      data.players.forEach(p => {
        playersList.innerHTML += `<div>${p.name}</div>`;
      });

      joinBtn.style.display = 'none';
      playerNameInput.style.display = 'none';
      disconnectBtn.style.display = 'block';
      startBtn.style.display = 'block';
    });

    socket.on('youAreHost', () => {
      iAmHost = true;
    });

    // Inicia la ronda
    socket.on('roundStarted', (data) => {
      // Quitar pantalla intermedia si estaba
      intermediateScreen.style.display = "none";

      lobbyDiv.style.display = 'none';
      gameDiv.style.display = 'block';
      resultsSection.style.display = 'none';
      winnerInfo.innerHTML = '';
      submissionsSection.style.display = 'none';
      submissionsList.innerHTML = '';
      statusMsg.innerText = '';
      discardingStatus.innerText = '';

      // Quién soy
      const me = data.players.find(p => p.id === myPlayerId);
      isZar = me ? me.isCzar : false;
      zarIndicator.style.display = isZar ? 'block' : 'none';
      blackCardPrompt.textContent = data.blackCard ? data.blackCard.text : 'Sin carta negra';

      hasSentCard = false;
      submitCardBtn.disabled = false;
      selectedCards = [];

      if (isZar) {
        submitCardBtn.style.display = 'none';
        statusMsg.innerText = "Eres el ZAR, no envías carta.";
      } else {
        submitCardBtn.style.display = 'inline-block';
      }

      // Botón terminar partida si soy host
      if (iAmHost) {
        endGameBtn.style.display = 'inline-block';
      }
    });

    // “showIntermediate”: Pantalla de 3 seg con un mensaje
    socket.on('showIntermediate', (data) => {
      intermediateMsg.textContent = data.message || "Espera un momento...";
      intermediateScreen.style.display = "flex";
    });

    // Mano actualizada
    socket.on('yourHand', (data) => {
      myHand = data.cards;
      renderMyHand();
    });

    // Muestran submissions
    socket.on('showSubmissions', (subs) => {
      submissionsSection.style.display = 'block';
      submissionsList.innerHTML = '';
      subs.forEach(s => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.margin = '5px';
        div.style.padding = '5px';
        div.innerHTML = `
          <p>${s.text}</p>
          ${
            isZar ? `<button onclick="selectWinner('${s.submissionId}')">Elegir Ganadora</button>` : ''
          }
        `;
        submissionsList.appendChild(div);
      });
    });

    // Al Zar elige ganador => roundResult
    socket.on('roundResult', (data) => {
      resultsSection.style.display = 'block';
      winnerInfo.innerHTML = 
        `Ganó <strong>${data.winnerName}</strong> (+1 punto).<br/>
         Total: ${data.totalPoints} puntos.`;
    });

    // stillDiscarding => “X, Y no descartaron. Tienen N seg...”
    socket.on('stillDiscarding', (data) => {
      discardingStatus.innerText = 
        `${data.names.join(', ')} todavía no descartaron. 
         Tienen ${data.timeLeft}s para hacerlo.`;
    });

    // Fase de descarte termina
    socket.on('discardPhaseEnded', () => {
      discardingStatus.innerText = '';
    });

    // Actualiza la mano tras descartar
    socket.on('updateHand', (d) => {
      myHand = d.cards;
      renderMyHand();
    });

    // Fin manual
    socket.on('gameEnded', (data) => {
      showFinalScores(data.scores);
    });

    /********************************************************
     * FUNCIONES
     ********************************************************/
    function renderMyHand() {
      myHandDiv.innerHTML = '';
      selectedCards = [];
      myHand.forEach(card => {
        const cDiv = document.createElement('div');
        cDiv.classList.add('card-selection');
        cDiv.textContent = card.text;
        cDiv.addEventListener('click', () => {
          toggleCard(card, cDiv);
        });
        myHandDiv.appendChild(cDiv);
      });
    }

    function toggleCard(card, elDiv) {
      const index = selectedCards.findIndex(x => x.id === card.id);
      if (index >= 0) {
        selectedCards.splice(index, 1);
        elDiv.classList.remove('card-selected');
      } else {
        let m = getMode();
        if (m === 'send') {
          if (hasSentCard) {
            alert("Ya enviaste tu carta.");
            return;
          }
          if (selectedCards.length >= 1) {
            alert("Solo 1 carta para enviar.");
            return;
          }
        } else if (m === 'discard') {
          if (selectedCards.length >= 3) {
            alert("Máximo 3 para descartar.");
            return;
          }
        }
        selectedCards.push(card);
        elDiv.classList.add('card-selected');
      }
    }

    function getMode() {
      for (let i=0; i<modeRadios.length; i++){
        if (modeRadios[i].checked) {
          return modeRadios[i].value; // "send" o "discard"
        }
      }
      return "send";
    }

    function selectWinner(submissionId) {
      socket.emit('selectWinner', submissionId);
    }
    window.selectWinner = selectWinner;

    function resetUI() {
      lobbyDiv.style.display = 'block';
      gameDiv.style.display = 'none';
      playerNameInput.value = '';
      joinBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';
      startBtn.style.display = 'none';
      endGameBtn.style.display = 'none';
      iAmHost = false;
    }

    function showFinalScores(scores) {
      let msg = "<h2>Puntajes Finales</h2><ul>";
      scores.forEach(s => {
        msg += `<li>${s.name}: ${s.points} pts</li>`;
      });
      msg += "</ul>";
      intermediateMsg.innerHTML = msg;
      intermediateScreen.style.display = "flex";

      setTimeout(() => {
        intermediateScreen.style.display = "none";
        resetUI();
      }, 4000);
    }
  </script>
</body>
</html>
