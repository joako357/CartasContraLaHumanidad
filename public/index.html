<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cards Against Humanity - Spanish Version by Joaquin</title>
  <style>
    body {
      margin:0; padding:0;
      font-family:"Trebuchet MS", sans-serif;
      background: linear-gradient(135deg, #3f4c6b, #606c88);
      color:#f0f0f0;
    }
    h1,h2,h3 {
      text-align:center;
      text-shadow:1px 1px 3px rgba(0,0,0,0.6);
    }
    #lobby,#game {
      max-width:850px; margin:30px auto;
      background:rgba(0,0,0,0.3);
      border-radius:15px;
      padding:20px;
      box-shadow:0 0 8px rgba(0,0,0,0.5);
    }
    #lobby {
      display:flex; flex-direction:column; align-items:center;
    }
    #lobby input[type="text"] {
      padding:8px; border:1px solid #ccc; border-radius:4px;
      margin-right:5px; margin-bottom:10px;
    }
    #playersList {
      margin-top:10px; background:rgba(255,255,255,0.1);
      border-radius:8px; padding:10px; width:60%;
      min-height:50px; text-align:left;
      box-shadow:inset 0 0 5px rgba(0,0,0,0.3);
    }

    button {
      background:#16a085; border:none; border-radius:4px;
      padding:10px 15px; color:#fff;
      cursor:pointer; font-size:1em; margin:5px;
      transition: background 0.3s, transform 0.3s; outline:none;
    }
    button:hover {
      background:#13816c; transform:scale(1.03);
    }
    button:disabled {
      background:#7f8c8d; cursor:not-allowed; transform:none;
    }
    #submissionsSection { margin-bottom:20px; }
    #discardingStatus {
      margin:10px 0; color:#f39c12; font-weight:bold;
    }
    #statusMsg {
      margin-top:10px; color:#1abc9c; font-style:italic;
    }
    #zarIndicator {
      color:#e74c3c; font-weight:bold; margin-bottom:10px;
    }

    .card-box {
      width:140px; height:200px; box-sizing:border-box;
      border:1px solid #aaa; border-radius:6px;
      padding:10px; margin:5px; display:inline-block;
      box-shadow:2px 2px 5px rgba(0,0,0,0.4);
      transition:transform 0.2s;
      background:#fafafa; color:#2c3e50;
      overflow:hidden; text-align:center;
      position:relative;
    }
    .card-box:hover {
      transform:scale(1.02);
    }
    .card-black {
      background:#2d3436; color:#fff;
    }
    .card-white {
      background:#fafafa; color:#2c3e50;
    }
    .card-selected {
      border:3px solid #16a085;
    }
    @keyframes sendingAnimation {
      0% { transform:scale(1) rotate(0deg);   opacity:1; }
      70%{transform:scale(1.2)rotate(5deg);  }
      100%{transform:scale(1)  rotate(10deg);opacity:0.3;}
    }
    @keyframes discardingAnimation {
      0% {transform:scale(1) rotate(0deg);    opacity:1;}
      70%{transform:scale(0.8)rotate(-5deg); }
      100%{transform:scale(1)  rotate(-10deg);opacity:0.3;}
    }
    .sendingCard {
      animation:sendingAnimation 0.8s forwards ease-in-out;
      pointer-events:none;
    }
    .discardingCard {
      animation:discardingAnimation 0.8s forwards ease-in-out;
      pointer-events:none;
    }
    .card-sent {
      filter:grayscale(80%); opacity:0.4; pointer-events:none;
    }

    #intermediateScreen {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); color:#fff;
      display:none; justify-content:center; align-items:center;
      text-align:center; z-index:9999;
    }
    #intermediateMsg {
      background:rgba(20,20,20,0.8);
      border:2px solid #16a085;
      border-radius:10px;
      width:380px; padding:20px;
      box-shadow:0 0 10px rgba(0,0,0,0.7);
      font-size:1.1em;
    }
    #winnerCard {
      margin-top:10px; color:#16a085; font-weight:bold;
    }
  </style>
</head>
<body>
  <h1>Cards Against Humanity - Spanish Version by Joaquin</h1>

  <div id="intermediateScreen">
    <div id="intermediateMsg"></div>
  </div>

  <!-- LOBBY -->
  <div id="lobby">
    <input type="text" id="playerName" placeholder="Tu nombre...">
    <button id="joinBtn">Unirse</button>
    <button id="startBtn" style="display:none;">Iniciar Partida</button>
    <button id="disconnectBtn" style="display:none;">Desconectarse</button>

    <div id="playersList"></div>
  </div>

  <!-- PARTIDA -->
  <div id="game" style="display:none;">
    <h2>Partida en curso</h2>
    <div id="zarIndicator" style="display:none;">¡Eres el ZAR!</div>

    <div id="submissionsSection" style="display:none;">
      <h3>Cartas enviadas:</h3>
      <div id="submissionsList"></div>
    </div>

    <div id="discardingStatus"></div>

    <div id="blackCardContainer" style="margin:15px 0;"></div>
    <div id="winnerCard" style="display:none;"></div>

    <div>
      <h3>Mi mano:</h3>
      <div id="myHand"></div>

      <div style="margin-top:10px;">
        <button id="sendBtn" style="display:none;">Enviar Carta Seleccionada</button>
        <button id="discardBtn">Descartar Cartas Seleccionadas (Max. 3)</button>
        <button id="omitBtn" style="display:none;">Omitir Descarte</button>
      </div>

      <div id="statusMsg"></div>
    </div>

    <div id="resultsSection" style="display:none; margin-top:20px;">
      <h3>Resultado de la Ronda:</h3>
      <div id="winnerInfo"></div>
    </div>

    <button id="endGameBtn" style="display:none; margin-top:20px;">Terminar Partida</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // LOBBY
    const lobbyDiv= document.getElementById('lobby');
    const playerNameInput= document.getElementById('playerName');
    const joinBtn= document.getElementById('joinBtn');
    const startBtn= document.getElementById('startBtn');
    const disconnectBtn= document.getElementById('disconnectBtn');
    const playersList= document.getElementById('playersList');

    // PARTIDA
    const gameDiv= document.getElementById('game');
    const zarIndicator= document.getElementById('zarIndicator');
    const submissionsSection= document.getElementById('submissionsSection');
    const submissionsList= document.getElementById('submissionsList');
    const discardingStatus= document.getElementById('discardingStatus');
    const blackCardContainer= document.getElementById('blackCardContainer');
    const winnerCardDiv= document.getElementById('winnerCard');
    const myHandDiv= document.getElementById('myHand');
    const statusMsg= document.getElementById('statusMsg');
    const resultsSection= document.getElementById('resultsSection');
    const winnerInfo= document.getElementById('winnerInfo');
    const endGameBtn= document.getElementById('endGameBtn');

    // Botones
    const sendBtn= document.getElementById('sendBtn');
    const discardBtn= document.getElementById('discardBtn');
    const omitBtn= document.getElementById('omitBtn');

    // Intermedia
    const intermediateScreen= document.getElementById('intermediateScreen');
    const intermediateMsg= document.getElementById('intermediateMsg');

    let myPlayerId= null;
    let isZar= false;
    let myHand= [];
    let selectedCards= [];
    let hasSentCard= false;    // evito multiple envíos
    let hasDiscardedLocally= false; // evito descartar local más de 1 vez

    // Conexiones
    socket.on('connect',()=>{
      myPlayerId= socket.id;
    });
    socket.on('errorMessage',(data)=>{
      alert(data.message);
    });

    // Lobby
    joinBtn.addEventListener('click',()=>{
      const name= playerNameInput.value.trim();
      if(name){
        socket.emit('joinGame', name);
      } else {
        alert("Ingresa un nombre válido");
      }
    });
    startBtn.addEventListener('click',()=>{
      socket.emit('startGame');
    });
    disconnectBtn.addEventListener('click',()=>{
      socket.emit('disconnectPlayer');
      resetUI();
    });
    endGameBtn.addEventListener('click',()=>{
      const pass= prompt('Contraseña ("joaquin"):');
      if(!pass)return;
      socket.emit('endGame', pass);
    });

    socket.on('updatePlayers',(data)=>{
      playersList.innerHTML= "<h3>Jugadores Conectados:</h3>";
      data.players.forEach(p=>{
        playersList.innerHTML+=`<div>${p.name}</div>`;
      });
      joinBtn.style.display='none';
      playerNameInput.style.display='none';
      disconnectBtn.style.display='block';
      startBtn.style.display='block';
    });

    // Partida
    socket.on('roundStarted',(data)=>{
      intermediateScreen.style.display='none';
      lobbyDiv.style.display='none';
      gameDiv.style.display='block';

      resultsSection.style.display='none';
      winnerInfo.innerHTML='';
      submissionsSection.style.display='none';
      submissionsList.innerHTML='';
      statusMsg.textContent='';
      discardingStatus.textContent='';
      winnerCardDiv.style.display='none';
      winnerCardDiv.innerText='';

      const me= data.players.find(x=> x.id=== myPlayerId);
      isZar= me ? me.isCzar : false;
      if(isZar){
        zarIndicator.style.display='block';
        sendBtn.style.display='none';
      } else {
        zarIndicator.style.display='none';
        sendBtn.style.display='inline-block';
      }
      sendBtn.disabled= false;
      selectedCards=[];
      hasSentCard= false;
      hasDiscardedLocally= false;

      if(data.blackCard){
        blackCardContainer.innerHTML= renderBlackCard(data.blackCard.text);
      } else {
        blackCardContainer.innerHTML= `<div class="card-box card-black">???</div>`;
      }
      endGameBtn.style.display='block';
      omitBtn.style.display='none';
    });

    socket.on('yourHand',(d)=>{
      myHand= d.cards;
      renderMyHand();
    });

    socket.on('showSubmissions',(subs)=>{
      submissionsSection.style.display='block';
      submissionsList.innerHTML='';
      subs.forEach(s=>{
        const div= document.createElement('div');
        div.classList.add('card-box','card-white');
        div.innerHTML=`
          <p style="margin-top:50px;">${s.text}</p>
          ${
            isZar? `<button onclick="selectWinner('${s.submissionId}')">Elegir Ganadora</button>`:''
          }
        `;
        submissionsList.appendChild(div);
      });
    });

    socket.on('roundResult',(d)=>{
      resultsSection.style.display='block';
      winnerInfo.innerHTML= `
        Ganó <strong>${d.winnerName}</strong> (+${d.pointsWon} punto).
        <br/>Total: ${d.totalPoints} puntos.
      `;
      winnerCardDiv.style.display='block';
      winnerCardDiv.innerHTML= renderWhiteCard(d.winnerCardText);
    });

    socket.on('hideSubmissions',()=>{
      submissionsSection.style.display='none';
      submissionsList.innerHTML='';
    });

    socket.on('stillDiscarding',(data)=>{
      discardingStatus.textContent= data.text;
      omitBtn.style.display='inline-block';
    });
    socket.on('discardPhaseEnded',()=>{
      discardingStatus.textContent='';
      omitBtn.style.display='none';
    });

    socket.on('showIntermediate',(d)=>{
      intermediateScreen.style.display='flex';
      let timeLeft= d.timeLeft||3;
      let msg= `<p>La siguiente ronda en <span id="countdownVal">${timeLeft}</span> seg...</p>`;
      if(d.scores){
        msg+="<h3>Puntajes actuales:</h3><ul>";
        d.scores.forEach(s=>{
          msg+=`<li>${s.name}: ${s.points}</li>`;
        });
        msg+="</ul>";
      }
      intermediateMsg.innerHTML= msg;

      let inter= setInterval(()=>{
        timeLeft--;
        const cdSpan= document.getElementById('countdownVal');
        if(cdSpan) cdSpan.textContent= timeLeft;
        if(timeLeft<=0) clearInterval(inter);
      },1000);
    });

    socket.on('updateHand',(d)=>{
      myHand= d.cards;
      renderMyHand();
    });

    socket.on('gameEnded',(d)=>{
      let txt= `<h2>¡Partida Finalizada!</h2><ul>`;
      d.scores.forEach(s=>{
        txt+=`<li>${s.name}: ${s.points}</li>`;
      });
      txt+="</ul>";
      intermediateMsg.innerHTML= txt;
      intermediateScreen.style.display='flex';
      setTimeout(()=>{
        intermediateScreen.style.display='none';
        resetUI();
      },4000);
    });

    /********************************************************
     * BOTONES PARTIDA
     ********************************************************/
    sendBtn.addEventListener('click',()=>{
      if(hasSentCard){
        statusMsg.textContent="Ya enviaste tu carta.";
        return;
      }
      if(selectedCards.length!==1){
        statusMsg.textContent="Selecciona 1 carta para enviar.";
        return;
      }
      if(isZar){
        statusMsg.textContent="Eres el ZAR, no envías carta.";
        return;
      }
      const chosen= selectedCards[0];
      if(chosen.__element){
        chosen.__element.classList.add('sendingCard');
        chosen.__element.addEventListener('animationend', onSendAnimationEnd);
      } else {
        doSendCard(chosen.id);
      }
    });
    function onSendAnimationEnd(e){
      const div= e.target;
      if(div.classList.contains('sendingCard')){
        div.removeEventListener('animationend', onSendAnimationEnd);
        div.classList.remove('sendingCard');
        div.classList.add('card-sent'); // gris
        doSendCard(parseInt(div.dataset.cardId));
      }
    }
    function doSendCard(cardId){
      socket.emit('sendCard', cardId);
      hasSentCard= true;
      sendBtn.disabled= true;
      statusMsg.textContent="Carta enviada.";
      selectedCards=[];
      renderMyHand();
    }

    discardBtn.addEventListener('click',()=>{
      // Comprobamos si local ya descartó
      if(hasDiscardedLocally){
        statusMsg.textContent="Ya descartaste una vez.";
        return;
      }
      // Revisa cuántas cartas
      if(selectedCards.length===0){
        statusMsg.textContent="No seleccionaste cartas para descartar.";
        return;
      }
      if(selectedCards.length>3){
        statusMsg.textContent="Máximo 3 cartas.";
        return;
      }
      // Animación a TODAS las cartas
      selectedCards.forEach(c=>{
        if(c.__element && !c.__element.classList.contains('card-sent')){
          c.__element.classList.add('discardingCard');
        }
      });
      // Al acabar la última anim, emitimos descartar
      // => Usamos un "setTimeout" en 900ms
      setTimeout(()=>{
        // Marcar local
        hasDiscardedLocally= true;
        // Listado IDs
        const arr= selectedCards.map(c=> c.id);
        socket.emit('discardCards', arr);
        statusMsg.textContent=`Descartaste ${selectedCards.length} carta(s).`;
        // Pasa a card-sent
        selectedCards.forEach(c=>{
          if(c.__element){
            c.__element.classList.remove('discardingCard');
            c.__element.classList.add('card-sent');
          }
        });
        selectedCards=[];
        renderMyHand();
      },900);
    });

    omitBtn.addEventListener('click',()=>{
      if(hasDiscardedLocally){
        statusMsg.textContent="Ya descartaste/omitiste antes.";
        return;
      }
      socket.emit('omitDiscard');
      statusMsg.textContent="Has omitido descartar.";
      omitBtn.style.display='none';
      hasDiscardedLocally= true;
    });

    /********************************************************
     * FUNCIONES
     ********************************************************/
    function resetUI(){
      lobbyDiv.style.display='block';
      gameDiv.style.display='none';
      playerNameInput.value='';
      joinBtn.style.display='block';
      disconnectBtn.style.display='none';
      startBtn.style.display='none';
      endGameBtn.style.display='none';
    }

    function renderMyHand(){
      myHandDiv.innerHTML='';
      selectedCards=[];
      myHand.forEach(card=>{
        const cDiv= document.createElement('div');
        cDiv.classList.add('card-box','card-white');
        cDiv.dataset.cardId= card.id;
        cDiv.innerHTML= `<div style="margin-top:50px;">${card.text}</div>`;
        card.__element= cDiv;

        cDiv.addEventListener('click',()=>{
          toggleCard(card,cDiv);
        });
        myHandDiv.appendChild(cDiv);
      });
    }

    function toggleCard(card, elDiv){
      // Si la carta está gris, no permitir
      if(elDiv.classList.contains('card-sent')) return;

      const i= selectedCards.findIndex(x=> x.id=== card.id);
      if(i>=0){
        selectedCards.splice(i,1);
        elDiv.classList.remove('card-selected');
      } else {
        // No permitir re-seleccionar la carta si ya se envió
        if(hasSentCard && !myHand.find(c=> c.id=== card.id)){
          return;
        }
        elDiv.classList.add('card-selected');
        selectedCards.push(card);
      }
    }

    function selectWinner(submissionId){
      socket.emit('selectWinner', submissionId);
    }
    window.selectWinner= selectWinner;

    function renderBlackCard(txt){
      return `<div class="card-box card-black">
                <div style="margin-top:50px;">${txt}</div>
              </div>`;
    }
    function renderWhiteCard(txt){
      return `<div class="card-box card-white">
                <div style="margin-top:50px;">${txt}</div>
              </div>`;
    }
  </script>
</body>
</html>
